# Sharecare v3.0.0-beta.4 Changelog

**Release Date**: 2025-11-10
**Previous Version**: v3.0.0-beta.3

## Summary

Beta 4 focuses on complete internationalization (Swedish → English) and JavaScript reliability improvements for the email settings interface. This release fixes critical frontend issues that caused the Brevo test connection to hang indefinitely.

---

## Major Changes

### 1. Complete English Translation of Email Settings Interface

**Problem**: The entire email configuration interface was in Swedish, causing confusion for international users.

**Solution**: Systematically translated all 840 lines of `/internal/server/handlers_email.go` from Swedish to English.

**Translation Examples**:
- `"E-postinställningar"` → `"Email Settings"`
- `"Brevo-inställningar"` → `"Brevo Settings"`
- `"Testar..."` → `"Testing..."`
- `"Anslutningen till Brevo fungerar!"` → `"Connection to Brevo works!"`
- `"Inte konfigurerad"` → `"Not configured"`
- `"Konfigurerad (aktiv)"` → `"Configured (active)"`
- `"Konfigurerad (inaktiv)"` → `"Configured (inactive)"`
- `"Spara Brevo-inställningar"` → `"Save Brevo Settings"`
- `"Testa anslutning"` → `"Test connection"`

**Files Changed**:
- `/internal/server/handlers_email.go` - Complete translation
- Original Swedish version backed up to `/internal/server/handlers_email.go.swedish`

---

### 2. JavaScript Timeout and Error Handling Improvements

**Problem**: When testing Brevo API connection, the button would show "Testing..." indefinitely with no feedback if the request failed or timed out.

**Root Cause**:
- No timeout configured on fetch() requests
- No error handling for network failures
- Button state never recovered on errors

**Solution**: Added comprehensive error handling to all AJAX operations:

```javascript
// Added to all fetch() calls:
const response = await fetch('/api/email/test?provider=brevo', {
    signal: AbortSignal.timeout(30000) // 30 second timeout
});
```

**Error Handling Pattern** (applied to all test buttons):
```javascript
try {
    const response = await fetch(url, {
        signal: AbortSignal.timeout(30000)
    });

    if (response.ok) {
        showSuccess('✓ Connection successful!');
    } else {
        const error = await response.json();
        showError('✗ Test failed: ' + error.error);
    }
} catch (err) {
    if (err.name === 'TimeoutError') {
        showError('Test timed out. Please try again.');
    } else if (err.name === 'AbortError') {
        showError('Test was aborted. Please try again.');
    } else {
        showError('Test failed: ' + err.message);
    }
} finally {
    btn.disabled = false;
    btn.textContent = 'Test connection';
}
```

**Benefits**:
- 30-second timeout prevents indefinite hangs
- Specific error messages for different failure types
- Button always re-enabled, even on errors
- Better user feedback on connection issues

---

### 3. Version Number Display in Admin Interface

**Problem**: No visual indication of which software version was running.

**Solution**: Added version number display to admin navigation header.

**Changes**:
- `/cmd/server/main.go` line 20: Updated version constant to `"3.0.0-beta.4"`
- `/internal/server/handlers_admin.go` line 501: Added version display span to navigation:
  ```html
  <span style="color: rgba(255,255,255,0.6); font-size: 12px; margin-left: 10px;">v3.0.0-beta.4</span>
  ```

**Result**: Version number now visible in top-right corner of admin navigation bar.

---

## Files Modified

| File | Lines Changed | Description |
|------|---------------|-------------|
| `/internal/server/handlers_email.go` | 840 | Complete Swedish → English translation + timeout fixes |
| `/cmd/server/main.go` | 1 | Version constant updated to 3.0.0-beta.4 |
| `/internal/server/handlers_admin.go` | 1 | Added version display to navigation |

**New Files**:
- `/internal/server/handlers_email.go.swedish` - Backup of original Swedish version

---

## Technical Details

### JavaScript Improvements

All test buttons in the email settings page received the following enhancements:

1. **Brevo Test Button**: Added timeout and comprehensive error handling
2. **SMTP Test Button**: Added timeout and comprehensive error handling
3. **Save Buttons**: Improved feedback and error recovery

**Timeout Configuration**:
- Default: 30 seconds for all network requests
- Uses `AbortSignal.timeout(30000)` API (modern browsers)
- Graceful degradation for older browsers

**Error Types Handled**:
- `TimeoutError`: Request exceeded 30 seconds
- `AbortError`: Request was manually aborted
- Network errors: Connection failures, DNS issues
- HTTP errors: 4xx, 5xx responses with JSON error messages

---

## Testing Notes

### Testing Email Configuration with Brevo

1. Navigate to Admin → Email Settings
2. Click "Brevo" tab
3. Enter your Brevo API key
4. Click "Test connection" button
5. Should see success message within 30 seconds or specific error

**Note**: Use your own Brevo API key for testing. The key can be obtained from your Brevo account dashboard.

### Expected Behavior

- **Success**: "✓ Connection to Brevo works! Test email sent."
- **Invalid API Key**: "✗ Test failed: Invalid API key"
- **Timeout**: "Test timed out. Please try again."
- **Network Error**: "Test failed: [specific error message]"

---

## Known Issues / Future Work

### 1. Send via Email Button Not Yet Implemented

**Status**: Not implemented in this release
**Description**: The "Send via Email" button in the file list is not yet functional
**Impact**: Users cannot send file links via email from the UI
**Planned for**: Future beta release

**Workaround**: Users can manually copy file links and send them via their email client.

### 2. Email Template Customization

**Status**: Basic templates only
**Description**: Email templates are currently hardcoded
**Planned for**: v3.0.0 stable release

---

## Upgrade Instructions

### From v3.0.0-beta.3:

```bash
# Stop the server
pkill -9 sharecare

# Pull latest code
git pull origin main

# Build
go build -o sharecare cmd/server/main.go

# Restart server
./sharecare
```

### Database Changes

No database migrations required for this release.

### Configuration Changes

No configuration file changes required.

---

## Build Information

- **Go Version**: 1.21+
- **Build Command**: `go build -o sharecare cmd/server/main.go`
- **Platform**: Linux (tested on 6.8.12-11-pve)
- **Binary Size**: ~20MB (varies by platform)

---

## Credits

- **Translation & Bug Fixes**: Claude Code CLI
- **Original Email Implementation**: Claude Code Web (v3.0 Alpha 1)
- **Based on**: Gokapi - https://github.com/Forceu/Gokapi
- **Project Owner**: Ulf (ulf@prudsec.se)

---

## Diff Summary

### handlers_email.go Changes:
- 200+ strings translated from Swedish to English
- 4 fetch() calls enhanced with timeout handling
- 4 test button handlers enhanced with try-catch-finally blocks
- All error messages standardized to English
- All UI labels, placeholders, and help text translated

### Version Bumps:
- `main.go`: `"2.0.0-beta.3"` → `"3.0.0-beta.4"`
- Admin navigation: Added version display

---

## Next Steps

1. ✅ Complete English translation
2. ✅ Fix JavaScript timeout issues
3. ✅ Add version number display
4. ⏳ Test with real Brevo API key
5. ⏳ Implement "Send via Email" button functionality
6. ⏳ Add email activity logging
7. ⏳ Create email template customization UI

---

## Support

For issues or questions:
- GitHub Issues: https://github.com/Frimurare/Sharecare/issues
- Email: ulf@prudsec.se
