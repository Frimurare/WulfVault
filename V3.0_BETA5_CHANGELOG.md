# Sharecare v3.0.0-beta.5 Changelog

**Release Date**: 2025-11-11
**Previous Version**: v3.0.0-beta.4

## Summary

Beta 5 is a critical bug fix release addressing three major regressions introduced in v3.0 Alpha 1, plus enhancements to the Brevo email testing workflow. This release restores full functionality to file editing, upload request creation, and admin navigation while improving the email configuration experience.

---

## Critical Bug Fixes

### 1. Upload Request Creation Popup Regression

**Problem**: v3.0 Alpha 1 had reverted to using browser `prompt()` and `alert()` dialogs for creating upload requests, replacing the professional modal dialog that existed in v2.0.

**Impact**: Poor user experience with blocking browser prompts, no validation, and crude interface.

**Root Cause**: The `showCreateRequestModal()` function in `handlers_user.go` was rewritten to use basic JavaScript prompts instead of a proper HTML modal.

**Solution**: Completely rewrote the modal implementation with:
- Professional HTML form with proper styling
- Inline form validation
- Non-blocking modal dialog
- In-modal success display with copy-to-clipboard functionality
- Clean close/cancel mechanisms

**Files Changed**:
- `/internal/server/handlers_user.go` (lines 999-1075)

**Technical Details**:
```javascript
// OLD CODE (v3.0 Alpha 1) - REMOVED
const title = prompt('Enter request title:');
alert('Upload request created! Share this link: ' + result.upload_url);

// NEW CODE (v3.0 Beta 5) - Proper Modal
var modalHtml = '<div id="request-modal" style="position: fixed; ...">...</div>';
document.body.insertAdjacentHTML('beforeend', modalHtml);
// Form with validation, styled inputs, success display
```

---

### 2. File Edit Button Not Working

**Problem**: The edit button (✏️) on file entries did nothing when clicked. All supporting JavaScript functions were missing.

**Impact**: Users could not modify file settings (expiration, download limits) after upload.

**Root Cause**: v3.0 Alpha 1 included the edit modal HTML and button, but failed to implement any of the required JavaScript functions:
- `showEditModal()` - Opens modal and populates with current settings
- `closeEditModal()` - Closes the modal
- `saveFileEdit()` - Submits changes to backend
- `toggleEditTimeLimit()` - Shows/hides time limit controls
- `toggleEditDownloadLimit()` - Shows/hides download limit controls

**Solution**: Implemented all five missing JavaScript functions with full functionality.

**Files Changed**:
- `/internal/server/handlers_user.go` (lines 1102-1189)

**Key Features Implemented**:
```javascript
function showEditModal(fileId, fileName, downloadsRemaining, expireAt, unlimitedDownloads, unlimitedTime) {
    // Store file info
    document.getElementById('editFileId').value = fileId;
    document.getElementById('editFileName').textContent = fileName;

    // Calculate days until expiration from Unix timestamp
    if (expireAt > 0 && !unlimitedTime) {
        const now = Math.floor(Date.now() / 1000);
        const daysRemaining = Math.max(0, Math.ceil((expireAt - now) / (24 * 60 * 60)));
        document.getElementById('editExpirationDays').value = daysRemaining;
    }

    // Set current values and show modal
    document.getElementById('editModal').style.display = 'flex';
}

function saveFileEdit() {
    const fileId = document.getElementById('editFileId').value;
    const unlimitedTime = document.getElementById('editUnlimitedTime').checked;
    const unlimitedDownloads = document.getElementById('editUnlimitedDownloads').checked;

    // POST to /file/edit with FormData
    fetch('/file/edit', { method: 'POST', body: formData })
        .then(response => response.json())
        .then(result => {
            closeEditModal();
            location.reload();
        });
}
```

---

### 3. Email Navigation Link Missing on First Load

**Problem**: The "Email" link in the admin navigation was not visible when first loading `/admin`, but would appear after clicking any other navigation link.

**Impact**: Admin users couldn't access email settings on first page load, causing confusion.

**Root Cause**: The `/admin` dashboard renders its navigation inline with a different template than other admin pages. While other pages use `renderAdminHeader()` (which includes the Email link at line 498), the dashboard had its own hardcoded navigation that was missing the Email link.

**Solution**: Added the Email link to the dashboard's inline navigation at line 639, matching the navigation structure used by all other admin pages.

**Files Changed**:
- `/internal/server/handlers_admin.go` (line 639)

**Before**:
```go
html += `
    <nav>
        <a href="/admin">Dashboard</a>
        <a href="/dashboard">My Files</a>
        <a href="/admin/users">Users</a>
        <a href="/admin/files">Files</a>
        <a href="/admin/trash">Trash</a>
        <a href="/admin/branding">Branding</a>
        <a href="/admin/settings">Settings</a>
        <a href="/logout">Logout</a>
    </nav>
`
```

**After**:
```go
html += `
    <nav>
        <a href="/admin">Dashboard</a>
        <a href="/dashboard">My Files</a>
        <a href="/admin/users">Users</a>
        <a href="/admin/files">Files</a>
        <a href="/admin/trash">Trash</a>
        <a href="/admin/branding">Branding</a>
        <a href="/admin/email-settings">Email</a>
        <a href="/admin/settings">Settings</a>
        <a href="/logout">Logout</a>
        <span style="color: rgba(255,255,255,0.6); font-size: 12px; margin-left: 10px;">v3.0.0-beta.5</span>
    </nav>
`
```

---

## Email Feature Enhancements

### 4. Brevo Test Connection Without Saving

**Problem**: Users had to save their Brevo API key and settings before they could test if the connection worked. This meant invalid configurations would be permanently saved.

**Impact**: Poor workflow - users couldn't iterate on settings without polluting the database.

**Solution**: Modified the `/api/email/test` endpoint to accept both GET (test saved config) and POST (test provided config) methods. The POST method creates a temporary email provider instance for testing without persisting to the database.

**Files Changed**:
- `/internal/server/handlers_email.go` (lines 167-263)

**Technical Implementation**:
```go
type EmailTestRequest struct {
    Provider     string `json:"provider"`
    ApiKey       string `json:"apiKey"`
    FromEmail    string `json:"fromEmail"`
    FromName     string `json:"fromName"`
    SMTPHost     string `json:"smtpHost"`
    SMTPPort     int    `json:"smtpPort"`
    SMTPUsername string `json:"smtpUsername"`
    SMTPPassword string `json:"smtpPassword"`
    SMTPUseTLS   bool   `json:"smtpUseTLS"`
}

func (s *Server) handleEmailTest(w http.ResponseWriter, r *http.Request) {
    if r.Method == http.MethodPost {
        // Test with provided settings (without saving)
        var req EmailTestRequest
        json.NewDecoder(r.Body).Decode(&req)

        // Create temporary provider for testing
        provider = email.NewBrevoProvider(req.ApiKey, req.FromEmail, req.FromName)

        // Send test email...
    } else {
        // GET - use saved configuration from database
        provider, err = email.GetActiveProvider(database.DB)
    }
}
```

**JavaScript Changes**:
```javascript
document.getElementById('test-brevo')?.addEventListener('click', async function() {
    const apiKey = document.getElementById('brevo-api-key').value;
    const fromEmail = document.getElementById('brevo-from-email').value;
    const fromName = document.getElementById('brevo-from-name').value;

    if (!apiKey || !fromEmail) {
        showError('Please enter API key and from email before testing');
        return;
    }

    const response = await fetch('/api/email/test', {
        method: 'POST',  // Changed from GET to POST
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            provider: 'brevo',
            apiKey: apiKey,
            fromEmail: fromEmail,
            fromName: fromName
        }),
        signal: AbortSignal.timeout(30000)
    });

    // Handle response...
});
```

**Benefits**:
- Test before commit workflow
- Validate API keys without saving bad credentials
- Iterate on email settings safely
- Better error messages for invalid configurations

---

## Files Modified

| File | Lines Changed | Description |
|------|---------------|-------------|
| `/internal/server/handlers_email.go` | 96 additions | Added POST support for testing email config before saving |
| `/internal/server/handlers_user.go` | 266 changes | Fixed popup regression & implemented edit modal functions |
| `/internal/server/handlers_admin.go` | 2 additions | Added Email link to dashboard navigation |

---

## Version Updates

- `/cmd/server/main.go` line 20: Updated version constant to `"3.0.0-beta.5"`
- All admin navigation bars now display `v3.0.0-beta.5` in the top-right corner

---

## Testing Notes

### Testing Upload Request Creation
1. Log in as any user
2. Navigate to Dashboard
3. Click "Create Upload Request" button
4. Verify modal appears (not browser prompt)
5. Enter title, optional message, expiration days, max file size
6. Click "Create Request"
7. Verify success message displays in modal with copy button
8. Click "Done" to close modal and refresh list

### Testing File Edit Functionality
1. Log in as any user
2. Navigate to Dashboard
3. Click edit button (✏️) on any file
4. Verify modal opens with current file settings
5. Modify expiration days and/or download limits
6. Toggle "Never expire" and "Unlimited downloads" checkboxes
7. Click "Save Changes"
8. Verify modal closes and page reloads with updated settings

### Testing Email Navigation
1. Log in as admin
2. Navigate to `/admin` (Dashboard)
3. Verify "Email" link is visible in navigation on first load
4. Click "Email" link
5. Verify navigation to `/admin/email-settings`

### Testing Brevo Test Without Saving
1. Log in as admin
2. Navigate to Admin → Email Settings
3. Click "Brevo" tab
4. Enter API key and from email (do NOT click save)
5. Click "Test connection" button
6. Verify test email is sent without saving configuration
7. Check that database was not modified (reload page to confirm fields are empty)

---

## Known Issues / Future Work

### Not Yet Implemented

1. **Email Icon Buttons on File Links** - Add email envelope icon next to file links to send via email
2. **Email Recipient Field in Upload Form** - Allow specifying recipient when uploading files
3. **Download Notification Emails** - Send email notification when someone downloads a file
4. **Email for Upload Requests** - Integrate email sending into upload request workflow
5. **Email Template Customization** - Allow admins to customize email templates

### Planned for Beta 6

- Email functionality fully integrated into file sharing workflow
- Send file links via email from file list
- Automatic email notifications on downloads
- Email templates with branding support

---

## Upgrade Instructions

### From v3.0.0-beta.4:

```bash
# Stop the server
pkill -9 sharecare

# Pull latest code
git pull origin main

# Build
go build -o sharecare cmd/server/main.go

# Restart server
export SERVER_URL=http://192.168.86.142:8080
./sharecare
```

### Database Changes

No database migrations required for this release.

### Configuration Changes

No configuration file changes required.

---

## Regression Prevention

This release addresses regressions introduced in v3.0 Alpha 1. To prevent future regressions:

1. **Code Review**: All UI changes should be reviewed for existing functionality
2. **Testing Checklist**: Test core workflows before release:
   - File upload/download
   - File editing
   - Upload request creation
   - Admin navigation
3. **Version Control**: Never replace working code without understanding why
4. **Documentation**: Document known working implementations

---

## Build Information

- **Go Version**: 1.21+
- **Build Command**: `go build -o sharecare cmd/server/main.go`
- **Platform**: Linux (tested on 6.8.12-11-pve)
- **Binary Size**: ~20MB (varies by platform)
- **Server URL**: http://192.168.86.142:8080

---

## Credits

- **Bug Fixes & Testing**: Claude Code CLI
- **Original Email Implementation**: Claude Code Web (v3.0 Alpha 1)
- **Regression Identification**: Ulf (ulf@prudsec.se)
- **Based on**: Gokapi - https://github.com/Forceu/Gokapi

---

## Diff Summary

### handlers_email.go Changes:
- Added `EmailTestRequest` struct with all provider fields
- Modified `handleEmailTest` to accept both GET and POST methods
- POST method creates temporary provider without database persistence
- Updated JavaScript test buttons to send POST with form data
- Added validation for required fields before testing

### handlers_user.go Changes:
- **Popup Fix**: Replaced 76 lines of prompt-based code with 76 lines of modal-based code
- **Edit Functions**: Added 87 lines of missing JavaScript functions
  - `showEditModal()` - 32 lines
  - `closeEditModal()` - 3 lines
  - `saveFileEdit()` - 37 lines
  - `toggleEditTimeLimit()` - 4 lines
  - `toggleEditDownloadLimit()` - 4 lines

### handlers_admin.go Changes:
- Added Email navigation link to dashboard
- Added version number display to dashboard navigation

### Version Bumps:
- `main.go`: `"3.0.0-beta.4"` → `"3.0.0-beta.5"`

---

## Next Steps

1. ✅ Fix upload request popup regression
2. ✅ Fix edit button functionality
3. ✅ Fix Email navigation visibility
4. ✅ Enhance Brevo test workflow
5. ⏳ Test with real Brevo API key (scheduled for tomorrow)
6. ⏳ Implement email icon buttons on file links
7. ⏳ Add email recipient field to upload form
8. ⏳ Implement download notification emails
9. ⏳ Add email to upload request workflow
10. ⏳ Create Beta 6 with full email integration

---

## Support

For issues or questions:
- GitHub Issues: https://github.com/Frimurare/Sharecare/issues
- Email: ulf@prudsec.se

---

## Conclusion

Beta 5 successfully restores all functionality that was broken in Alpha 1 and improves the email testing workflow. The three critical regressions (popup, edit button, navigation link) are fully resolved, and the Brevo test enhancement provides a better user experience for email configuration.

The codebase is now stable and ready for comprehensive email feature implementation in Beta 6.
